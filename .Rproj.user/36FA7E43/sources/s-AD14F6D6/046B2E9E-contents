
#libraries to install and load
install.packages("corrplot")
library(corrplot)
install.packages("psych")
library(psych)
install.packages("Hmisc")
library(Hmisc)

# construct dataframe (or import if it is already constructed elsewhere)
exercise <- c(0,0,0,2,2,2,2,4,4,4)
intake <- c(2,4,6,2,4,6,8,4,6,8)
wtloss <- c(6,2,4,8,9,8,5,11,13,9)
data <- data.frame(exercise, intake, wtloss)

View(data)
psych::describe(data)

corr.matrix <- rcorr(as.matrix(data))
corr.matrix

corrplot(corr.matrix$r, method="number", type="lower")

pcor1 <- partial.r(data, x=c(1, 3), y=(2))#the relationship between exercise and wtloss with food intake partialed out
round(pcor1, 2)


pcor2 <- partial.r(data, x=c(3, 2), y=(1))#the relationship between food intake and wtloss with exercise partialed out. Recall in our ordinary correlation matrix that food intake and wtloss were positively related, but the partial correlation is strongly negative. This is an example of a suppression effect. 
round(pcor2, 2)

pcor3 <- partial.r(data, x=c(1, 2), y=(3))#the relationship between exercise and intake with wtloss partialed out
round(pcor3, 2)



#another way to compute partial r --- fit two simple linear regression models Y ~ Z and X ~ Z, obtain the residuals from those regressions and correlate them
model1 <- lm(wtloss ~ intake, data=data) #predicting wtloss with food intake
summary(model1)
e1 <- residuals(model1)
plot(data$intake, data$wtloss)
abline(model1)

model2 <- lm(exercise ~ intake, data=data) #predicting exercise with food intake
summary(model2)
e2 <- residuals(model2)
plot(data$intake, data$exercise)
abline(model2)

model3 <- lm(intake ~ wtloss, data=data) #predicting intake with wtloss
summary(model3)
e3 <- residuals(model3)

model4 <- lm(wtloss ~ exercise, data=data) #predicting wtloss with exercise
summary(model4)
e4 <- residuals(model4)
plot(data$exercise, data$wtloss)
abline(model4)

model5 <- lm(intake ~ exercise, data=data) #predicting intake with exercise
summary(model5)
e5 <- residuals(model5)

model6 <- lm(exercise ~ wtloss, data=data) #predicting exercise with wtloss
summary(model6)
e6 <- residuals(model6)

MRmodel1 <- lm(wtloss ~ exercise + intake, data=data) #predicting wtloss with exercise and food intake
summary(MRmodel1)


## Correlating the residuals from the models above to find partial correlations
cor(e1, e2) ##this is partial r of exercise and wtloss with food intake partialed out
cor(e4, e5) ##this is partial r of food intake and wtloss with exercise partialed out
cor(e3, e6) ## this is partial r of exercise and food intake with wtloss partialed out

#semi-partial correlations
cor(e2, data$wtloss) #in Dr. Gillans example
cor(e5, data$wtloss) #in Dr. Gillans example
